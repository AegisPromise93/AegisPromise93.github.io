<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Minecraft 伺服器資源控製策略：AI抑制而非數量限制 · Utopia Update Blog</title><meta name="description" content="Minecraft 伺服器資源控製策略：AI抑制而非數量限制 - MICROSOFT &amp; Utopia Team"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="blog.utopia.nyaacat.cc/atom.xml" title="Utopia Update Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/rules.pdf" target="_self" class="nav-list-link">RULES</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/@AegisPromise" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/AegisPromise93" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Minecraft 伺服器資源控製策略：AI抑制而非數量限制</h1><div class="post-info">Dec 29, 2017</div><div class="post-content"><p>Minecraft 的 lag 問題已經司空見慣，各種控制資源消耗和卡頓的插件（plugin）也層出不窮。但是它們幾乎都非常用力地在一個點上：控制實體數量。</p>
<p>這並不無道理，因爲 Minecraft 中最消耗資源的部分就是實體。但是暴力控制實體數量會導致刷怪塔無法工作、掉落物清理過快等問題，在生存伺服器上可能引起玩家的强烈不滿。</p>
<p>所以，喵窩開發組從另一個角度做出了一些嘗試。</p>
<a id="more"></a>
<h2 id="啓發"><a href="#啓發" class="headerlink" title="啓發"></a>啓發</h2><p>生物實體的數量巨大，主要集中的地區顯然不是野外的自然刷怪區，而是玩家聚集的刷怪場、村民工程、動物養殖場等。如果不限制生物的數量和密度同時降低資源消耗，那麽衹能從生物實體的特性入手了。</p>
<p>Minecraft 最近的版本中引用了 <code>NoAI</code> 的NBT Tag，帶有此標簽的生物將不會進行 AI 計算。換句話説，除了占用伺服器内存中的一點數據，幾乎不會對這個生物實體有任何其他的 CPU 算力消耗。</p>
<p>也就是説，實體消耗的算力資源，絕大部分都是 AI 計算的消耗。</p>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>抓上一票人做了一些測試，結果證實生物失去 AI 后大幅降低了 CPU 的算力消耗。這是個 positve 的信號，但是接下來的測試則遇到了問題。</p>
<p>對於養殖場，等生物數量變化不大（或者說衹是定期來清理并重新養殖一次）的設施，生物失去 AI 的影響很小，衹有在重新繁殖的時候需要恢復 AI。 但是刷怪塔因爲生物沒有 AI ，同時也被强制不受重力影響而幾乎無法使用，即便同時設置 NoGravity 為 false 也無效。</p>
<p>開發組中 <a href="https://im.librazy.org/" target="_blank" rel="noopener">@Librazy</a> 提到了 Spigot 的一個<a href="https://www.spigotmc.org/wiki/spigot-configuration/" target="_blank" rel="noopener">參數</a>  <code>nerf-spawner-mobs</code>，開啓時刷怪籠生成的生物將不會擁有 AI ，但是會被外界影響（例如水流和火球等）而移動。這個選項是全局的，因此不需要開啓，衹需要反射 spigot 中設置該功能的方法即可。</p>
<p>於是整個方案的流程便是儅伺服器卡頓時抑制生物密集區的生物 AI 從而降低資源占用，同時最大程度上保證玩家對生物的需求。『伺服器卡頓』的考量以伺服器 TPS 而非實體數量爲準，儅伺服器 TPS 高於一定值時即認爲伺服器沒有超負荷，不進行任何操作，最大程度上利用硬件的性能。</p>
<h2 id="實現"><a href="#實現" class="headerlink" title="實現"></a>實現</h2><p>插件主要由開發組的 <a href="https://github.com/cyilin" target="_blank" rel="noopener">@Cylin</a> 和 <a href="https://github.com/Librazy" target="_blank" rel="noopener">@Librazy</a> 編寫，源代碼以 <code>MIT</code> 開源協議發佈在<a href="https://github.com/NyaaCat/yasui" target="_blank" rel="noopener">Github</a>上。</p>
<p>插件每隔一段時間掃描伺服器的 TPS 確認運行狀態，如果 TPS 低於閥值則觸發 AI 控制， TPS 高於一定值且持續一段時間即認爲伺服器已恢復正常運行狀態，自動恢復被抑制的實體 AI 減少對生存體驗的影響。</p>
<p>實現過程中額外添加了一些可能被生存伺服器用到的功能：</p>
<p>   ·per-world 控制，如果玩家需要建造以仇恨爲基礎的小黑塔，可以關閉對末地的控制。<br>   ·實體總量和單區塊實體密度在 AI 抑制時納入考慮，更加精準抑制資源消耗較高的區塊。</p>
<h2 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h2><p><a href="https://github.com/NyaaCat/yasui" target="_blank" rel="noopener">yasui</a> 插件在 <a href="https://craft.moe/" target="_blank" rel="noopener">毛玉綫圈物語</a> 伺服器中應用測試。由於近期玩家數量爆炸式增長（日常在綫 5 人到~30 人甚至 50 人），各種實體控制插件均告無效。yasui 插件應用后被證實數次發揮作用，沒有任何實體數量限制的前提下將伺服器 TPS 穩定在 19.0 以上，伺服器實體承載數量從 ~2500 提升至接近 5000，而且還有繼續提高的可能（數次觸發中最高一次單世界實體記錄是 4808，其他世界中仍有大約 2000 實體未被計入）。</p>
<h2 id="來源"><a href="#來源" class="headerlink" title="來源"></a>來源</h2><p>從<a href="https://blog.phoenixlzx.com/2017/05/05/reduce-minecraft-server-lag-without-limit-mob-amount/" target="_blank" rel="noopener">Phoenix’s island</a>轉載。<br>特別感謝<a href="https://github.com/NyaaCat" target="_blank" rel="noopener">喵窩開發組</a>！<br>特別感謝<a href="https://nyaa.cat" target="_blank" rel="noopener">喵窩 | NyaaCat 社區</a>的各位苣菊！<br>特別感謝<a href="https://craft.moe" target="_blank" rel="noopener">毛玉綫圈物語·Sunshine!</a>提供了測試環境！<br>由 簡體中文（zh-CN） 翻譯為 正體中文（zh-TW）</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/12/29/伺服器看起來好像咕咕了/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="blog.utopia.nyaacat.cc">MICROSOFT & Utopia Team</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>